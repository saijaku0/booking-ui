<div class="reviews-section">
  <h2>Patient Reviews ({{ reviews().length }})</h2>

  @if (authService.currentUser(); as user) {
    <div class="add-review-box">
      <h3>Leave a Review</h3>

      <div class="star-rating" (mouseleave)="clearHover()">
        @for (star of stars; track star) {
          <button
            type="button"
            class="star-btn"
            [class.filled]="star <= (hoverRating() || userRating())"
            (mouseenter)="setHover(star)"
            (click)="setRating(star)"
            [disabled]="isSubmitting()"
          >
            <span class="material-icons">
              {{ star <= (hoverRating() || userRating()) ? 'star' : 'star_border' }}
            </span>
          </button>
        }
      </div>

      <textarea
        [ngModel]="comment()"
        (ngModelChange)="comment.set($event)"
        placeholder="Share your experience..."
        rows="3"
        [disabled]="isSubmitting()"
      ></textarea>

      <button
        class="submit-btn"
        (click)="sendReview()"
        [disabled]="userRating() === 0 || isSubmitting()"
      >
        {{ isSubmitting() ? 'Submitting...' : 'Post Review' }}
      </button>
    </div>
  } @else {
    <p class="login-hint">Please <a routerLink="/auth/login">log in</a> to leave a review.</p>
  }

  <hr class="divider" />

  <div class="reviews-list">
    @if (isLoading()) {
      <div class="loading-spinner">Загрузка отзывов...</div>
    } @else {
      @for (review of reviews(); track review.id) {
        <div class="review-item">
          <div class="review-header">
            <img
              [src]="
                'https://ui-avatars.com/api/?name=' +
                review.patientName +
                '&background=random&color=fff&size=40'
              "
              alt="Avatar"
              class="avatar"
            />
            <div class="reviewer-info">
              <span class="name">{{ review.patientName }}</span>
              <span class="date">{{ review.createdAt | date: 'mediumDate' }}</span>
            </div>
            <div class="review-stars static">
              @for (star of stars; track star) {
                <span class="material-icons">
                  {{ star <= review.rating ? 'star' : 'star_border' }}
                </span>
              }
            </div>
          </div>
          <p class="review-text">{{ review.text }}</p>
        </div>
      } @empty {
        <p class="empty-state">No reviews yet. Be the first!</p>
      }
    }
  </div>
</div>
