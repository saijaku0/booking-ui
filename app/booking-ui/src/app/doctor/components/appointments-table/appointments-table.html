<div class="table-container" (click)="closeMenu()" (keyup)="closeMenu()" tabindex="1">
  <div class="table-controls">
    <div class="search-wrapper">
      <span class="material-icons">search</span>
      <input
        type="text"
        placeholder="Search patient..."
        [value]="searchQuery()"
        (input)="onSearch($event)"
      />
    </div>

    <div class="filters-wrapper">
      <div class="filter-group">
        <span class="label">Time:</span>
        <button [class.active]="periodFilter() === 'all'" (click)="setFilter('period', 'all')">
          All
        </button>
        <button [class.active]="periodFilter() === 'today'" (click)="setFilter('period', 'today')">
          Today
        </button>
        <button
          [class.active]="periodFilter() === 'upcoming'"
          (click)="setFilter('period', 'upcoming')"
        >
          Upcoming
        </button>
      </div>

      <div class="divider"></div>

      <div class="filter-group">
        <span class="label">Status:</span>
        <select #statusSelect (change)="setFilter('status', statusSelect.value)">
          <option value="all">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="completed">Completed</option>
          <option value="canceled">Canceled</option>
        </select>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="styled-table">
      <thead>
        <tr>
          <th width="15%">Time</th>
          <th width="30%">Patient</th>
          <th width="20%">Date</th>
          <th width="20%">Status</th>
          <th width="15%" class="text-right">Action</th>
        </tr>
      </thead>
      <tbody>
        @if (isLoading) {
          <tr>
            <td colspan="5" class="center-message">
              <div class="spinner-small"></div>
              Loading...
            </td>
          </tr>
        } @else if (filteredAppointments().length === 0) {
          <tr>
            <td colspan="5" class="center-message">No appointments found.</td>
          </tr>
        } @else {
          @for (row of filteredAppointments(); track row.id) {
            <tr>
              <td class="time-cell">
                <span class="material-icons icon-clock">schedule</span>
                {{ row.startTime | date: 'shortTime' }}
              </td>

              <td>
                <div class="patient-info">
                  <div class="avatar" [style.background]="generateColor(row.patientName)">
                    {{ getInitials(row.patientName) }}
                  </div>
                  <span class="name">{{ row.patientName }}</span>
                </div>
              </td>

              <td class="date-cell">{{ row.startTime | date: 'mediumDate' }}</td>

              <td>
                <span class="status-badge" [class]="row.status.toLowerCase()">
                  {{ row.status }}
                </span>
              </td>

              <td class="text-right relative">
                <button class="action-btn" (click)="toggleMenu(row.id, $event)">
                  <span class="material-icons">more_vert</span>
                </button>

                @if (activeMenuId() === row.id) {
                  <div
                    class="dropdown-menu"
                    (click)="$event.stopPropagation()"
                    (keyup)="$event.stopPropagation()"
                    tabindex="2"
                  >
                    <button (click)="emitAction('view', row.id)">
                      <span class="material-icons">visibility</span> View Details
                    </button>

                    <button (click)="emitAction('reschedule', row.id)">
                      <span class="material-icons">edit_calendar</span> Reschedule
                    </button>

                    @if (row.status === 'Pending') {
                      <button (click)="emitAction('confirm', row.id)" class="confirm">
                        <span class="material-icons">check</span> Confirm
                      </button>
                    }

                    @if (row.status === 'Confirmed') {
                      <button (click)="emitAction('complete', row.id)" class="complete">
                        <span class="material-icons">done_all</span> Complete
                      </button>
                    }

                    <button (click)="emitAction('cancel', row.id)" class="cancel">
                      <span class="material-icons">close</span> Cancel
                    </button>
                  </div>
                }
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>
</div>
